# Migration: v2.x → v3.0

This document describes the migration from blueprint format version 2.x to 3.0.

## Overview

Version 3.0 introduces a cleaner architecture with proper separation of concerns:

1. **State consolidation** - Blueprint state moves from `.claude/blueprints/` to `docs/blueprint/`
2. **Terminology fix** - Generated "skills" were actually rules; they now go to `.claude/rules/`
3. **Simplified structure** - No more `generated/` subdirectory; rules live directly in `.claude/rules/`
4. **Schema update** - Manifest field `generated.skills` becomes `generated.rules`

Key changes:
- `.claude/blueprints/.manifest.json` → `docs/blueprint/.manifest.json`
- `.claude/blueprints/work-orders/` → `docs/blueprint/work-orders/`
- `.claude/blueprints/work-overview.md` → `docs/blueprint/work-overview.md`
- `.claude/blueprints/generated/skills/` → `.claude/rules/` (with proper naming)
- Manifest schema: `generated.skills` → `generated.rules`

## Pre-Migration Checks

Before starting, verify:

```bash
# 1. Manifest exists at v2.x location
test -f .claude/blueprints/.manifest.json

# 2. Read current version
jq -r '.format_version // "1.0.0"' .claude/blueprints/.manifest.json

# 3. Verify version is 2.x
version=$(jq -r '.format_version // "1.0.0"' .claude/blueprints/.manifest.json)
if [[ ! "$version" =~ ^2\. ]]; then
  echo "ERROR: Expected v2.x, found $version"
  exit 1
fi

# 4. Check for uncommitted changes (recommend commit first)
git status --porcelain

# 5. List generated skills that will become rules
jq -r '.generated.skills | keys[]' .claude/blueprints/.manifest.json 2>/dev/null
```

**Confirmation**: "Current version is v{version}. Proceed with migration to v3.0.0?"

## Migration Steps

### Step 1: Check for User Modifications

Before moving generated content, check if user has modified any generated files:

```bash
# For each generated skill, compare current hash with stored hash
for skill in $(jq -r '.generated.skills | keys[]' .claude/blueprints/.manifest.json 2>/dev/null); do
  stored_hash=$(jq -r ".generated.skills[\"$skill\"].content_hash" .claude/blueprints/.manifest.json)
  current_hash=$(sha256sum ".claude/blueprints/generated/skills/$skill/skill.md" 2>/dev/null | cut -d' ' -f1)

  if [[ "$stored_hash" != "$current_hash" && -n "$current_hash" ]]; then
    echo "MODIFIED: $skill"
  fi
done
```

**If modifications detected**, ask user:
```
Use AskUserQuestion:
question: "The following generated content has been modified: {modified_list}. What would you like to do?"
options:
  - "Keep modifications (will preserve in .claude/rules/)"
  - "Discard modifications (will use original generated content)"
  - "Cancel migration to review changes first"
```

### Step 2: Create New Directory Structure

Create the docs/blueprint/ directory:

```bash
mkdir -p docs/blueprint/work-orders/completed
mkdir -p docs/blueprint/work-orders/archived
```

**Confirmation**: "Create docs/blueprint/ directory structure?"

### Step 3: Move State Files to docs/blueprint/

Move the manifest and work tracking files:

```bash
# Move manifest
if [[ -f .claude/blueprints/.manifest.json ]]; then
  cp .claude/blueprints/.manifest.json docs/blueprint/.manifest.json
fi

# Move work overview
if [[ -f .claude/blueprints/work-overview.md ]]; then
  mv .claude/blueprints/work-overview.md docs/blueprint/work-overview.md
fi

# Move work orders
if [[ -d .claude/blueprints/work-orders ]] && [[ "$(ls -A .claude/blueprints/work-orders)" ]]; then
  cp -r .claude/blueprints/work-orders/* docs/blueprint/work-orders/
fi

# Move feature tracker if exists
if [[ -f .claude/blueprints/feature-tracker.json ]]; then
  mv .claude/blueprints/feature-tracker.json docs/blueprint/feature-tracker.json
fi
```

**Verification**:
```bash
# Verify files moved
test -f docs/blueprint/.manifest.json && echo "Manifest: OK" || echo "Manifest: MISSING"
```

**Confirmation**: "Move state files from .claude/blueprints/ to docs/blueprint/?"

### Step 4: Ensure .claude/rules/ Directory Exists

```bash
mkdir -p .claude/rules
```

### Step 5: Move Generated Skills to Rules

Generated "skills" were actually rules. Move them to `.claude/rules/`:

```bash
# For each generated skill
for skill_dir in .claude/blueprints/generated/skills/*/; do
  if [[ -d "$skill_dir" ]]; then
    skill_name=$(basename "$skill_dir")
    skill_file="$skill_dir/skill.md"

    if [[ -f "$skill_file" ]]; then
      # Convert skill.md to rule format (kebab-case.md)
      # Remove skill.md subdirectory structure - rules are flat files
      cp "$skill_file" ".claude/rules/${skill_name}.md"
      echo "Moved: $skill_name → .claude/rules/${skill_name}.md"
    fi
  fi
done
```

**Confirmation**: "Move {count} generated skills to .claude/rules/ as rules?"

### Step 6: Update Manifest Schema

Transform manifest from v2.x to v3.0 schema:

**Old schema (v2.x):**
```json
{
  "format_version": "2.0.0",
  "generated": {
    "skills": {
      "architecture-patterns": {
        "source": "docs/prds/project-overview.md",
        "source_hash": "sha256:...",
        "generated_at": "2025-12-22T...",
        "plugin_version": "2.0.0",
        "content_hash": "sha256:...",
        "status": "current"
      }
    },
    "commands": {}
  },
  "custom_overrides": {
    "skills": [],
    "commands": []
  }
}
```

**New schema (v3.0):**
```json
{
  "format_version": "3.0.0",
  "generated": {
    "rules": {
      "architecture-patterns": {
        "source": "docs/prds/project-overview.md",
        "source_hash": "sha256:...",
        "generated_at": "2025-12-22T...",
        "plugin_version": "3.0.0",
        "content_hash": "sha256:...",
        "output_path": ".claude/rules/architecture-patterns.md",
        "status": "current"
      }
    },
    "commands": {}
  },
  "custom_overrides": {
    "rules": [],
    "commands": []
  }
}
```

**Transformation steps**:

1. Update `format_version` to "3.0.0"
2. Rename `generated.skills` to `generated.rules`
3. Add `output_path` field to each rule entry
4. Rename `custom_overrides.skills` to `custom_overrides.rules`
5. Update `updated_at` timestamp
6. Add upgrade history entry

```bash
# Transform manifest using jq
jq '
  .format_version = "3.0.0" |
  .generated.rules = (.generated.skills // {}) |
  del(.generated.skills) |
  .generated.rules |= with_entries(
    .value.output_path = ".claude/rules/\(.key).md" |
    .value.plugin_version = "3.0.0"
  ) |
  .custom_overrides.rules = (.custom_overrides.skills // []) |
  del(.custom_overrides.skills) |
  .updated_at = (now | strftime("%Y-%m-%dT%H:%M:%SZ")) |
  .upgrade_history += [{
    "from": (.format_version // "2.0.0"),
    "to": "3.0.0",
    "date": (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
    "changes": [
      "Moved state to docs/blueprint/",
      "Converted generated skills to rules",
      "Updated manifest schema"
    ]
  }]
' docs/blueprint/.manifest.json > docs/blueprint/.manifest.json.tmp && \
mv docs/blueprint/.manifest.json.tmp docs/blueprint/.manifest.json
```

### Step 7: Add README to docs/blueprint/

Create a README explaining the blueprint directory:

```bash
cat > docs/blueprint/README.md << 'EOF'
# Blueprint Development

This directory contains Blueprint Development state and artifacts.

## Contents

| Path | Purpose |
|------|---------|
| `.manifest.json` | Blueprint version and generation tracking |
| `work-overview.md` | Current work progress and phases |
| `work-orders/` | Task packages for subagents |
| `feature-tracker.json` | Feature implementation tracking (if enabled) |

## Related Directories

| Path | Purpose |
|------|---------|
| `docs/prds/` | Product Requirements Documents |
| `docs/adrs/` | Architecture Decision Records |
| `docs/prps/` | Product Requirement Prompts |
| `.claude/rules/` | Generated and custom rules |
| `.claude/commands/` | Custom commands |

## Commands

Run `/blueprint:status` to see current configuration.
Run `/blueprint:upgrade` to check for format updates.

## Version

This project uses Blueprint format version 3.0.0.
EOF
```

### Step 8: Update Documentation References

If project has a `CLAUDE.md`, update any references to old paths:

| Old Path | New Path |
|----------|----------|
| `.claude/blueprints/.manifest.json` | `docs/blueprint/.manifest.json` |
| `.claude/blueprints/work-overview.md` | `docs/blueprint/work-overview.md` |
| `.claude/blueprints/work-orders/` | `docs/blueprint/work-orders/` |
| `.claude/blueprints/generated/skills/` | `.claude/rules/` |

### Step 9: Clean Up Old Directories

Remove the old directory structure only after verification:

```bash
# Only remove if migration verified
if [[ -f docs/blueprint/.manifest.json ]]; then
  # Remove generated directory (content moved to .claude/rules/)
  rm -rf .claude/blueprints/generated

  # Remove work-orders (moved to docs/blueprint/)
  rm -rf .claude/blueprints/work-orders

  # Remove old manifest (moved to docs/blueprint/)
  rm -f .claude/blueprints/.manifest.json

  # Remove work-overview (moved to docs/blueprint/)
  rm -f .claude/blueprints/work-overview.md

  # Remove feature-tracker if it was moved
  rm -f .claude/blueprints/feature-tracker.json

  # Remove ai_docs if empty
  [ -z "$(ls -A .claude/blueprints/ai_docs 2>/dev/null)" ] && rm -rf .claude/blueprints/ai_docs

  # Remove blueprints directory if empty
  [ -z "$(ls -A .claude/blueprints 2>/dev/null)" ] && rmdir .claude/blueprints
fi
```

**Confirmation**: "Remove old .claude/blueprints/ structure? (Content has been migrated)"

## Post-Migration Verification

After migration, verify:

```bash
# 1. Manifest exists at new location with correct version
jq -r '.format_version' docs/blueprint/.manifest.json
# Expected: 3.0.0

# 2. Manifest has rules section (not skills)
jq -e '.generated.rules' docs/blueprint/.manifest.json > /dev/null && echo "Rules section: OK"

# 3. Work overview exists
test -f docs/blueprint/work-overview.md && echo "Work overview: OK"

# 4. Rules directory has content (if there were generated skills)
ls -la .claude/rules/*.md 2>/dev/null | head -5

# 5. Old directories removed
! test -d .claude/blueprints/generated && echo "Old generated/ removed: OK"
! test -f .claude/blueprints/.manifest.json && echo "Old manifest removed: OK"

# 6. No orphaned files in old location
[ -z "$(ls -A .claude/blueprints 2>/dev/null)" ] && echo "No orphaned files: OK"
```

## Migration Summary Template

```
Blueprint Migration Complete (v2.x → v3.0)

State moved to docs/blueprint/:
- .manifest.json
- work-overview.md
- work-orders/ ({n} orders)
- feature-tracker.json (if enabled)

Generated content converted:
- {n} skills → .claude/rules/*.md

Manifest schema updated:
- generated.skills → generated.rules
- custom_overrides.skills → custom_overrides.rules
- Added output_path field to rule entries

Old directories cleaned up:
- .claude/blueprints/generated/ (removed)
- .claude/blueprints/.manifest.json (removed)

Next steps:
1. Run /blueprint:status to verify configuration
2. Review .claude/rules/ for generated rules
3. Commit migration changes
```

## Rollback

If migration fails or needs to be reverted:

1. **Check git status** for changes made
2. **Restore from git** if changes were staged:
   ```bash
   git checkout -- .claude/
   git checkout -- docs/blueprint/
   ```

3. **Manual rollback** if not using git:
   ```bash
   # Move manifest back
   mv docs/blueprint/.manifest.json .claude/blueprints/.manifest.json

   # Move work overview back
   mv docs/blueprint/work-overview.md .claude/blueprints/work-overview.md

   # Move work orders back
   mv docs/blueprint/work-orders/* .claude/blueprints/work-orders/

   # Move rules back to generated skills (requires recreating skill.md structure)
   for rule in .claude/rules/*.md; do
     name=$(basename "$rule" .md)
     mkdir -p ".claude/blueprints/generated/skills/$name"
     mv "$rule" ".claude/blueprints/generated/skills/$name/skill.md"
   done

   # Clean up new directories
   rm -rf docs/blueprint
   ```

4. **Restore manifest schema**:
   ```bash
   jq '
     .format_version = "2.0.0" |
     .generated.skills = (.generated.rules // {}) |
     del(.generated.rules) |
     .custom_overrides.skills = (.custom_overrides.rules // []) |
     del(.custom_overrides.rules)
   ' .claude/blueprints/.manifest.json > .claude/blueprints/.manifest.json.tmp && \
   mv .claude/blueprints/.manifest.json.tmp .claude/blueprints/.manifest.json
   ```

5. **Report failure point** for debugging
