# Migration: v3.0 → v3.1

This document describes the migration from blueprint format version 3.0 to 3.1.

## Overview

Version 3.1 consolidates progress tracking and removes deprecated artifacts:

1. **work-overview.md removed** - Task tracking consolidated into `feature-tracker.json` (`tasks` and `current_phase` fields)
2. **Deprecated generated commands cleaned up** - `/blueprint:generate-commands` output removed
3. **Blueprint README updated** - Removes stale `work-overview.md` reference

Key changes:
- `docs/blueprint/work-overview.md` → removed (consolidated into `feature-tracker.json`)
- Generated commands/skills from `/blueprint:generate-commands` → removed (deprecated)
- `docs/blueprint/README.md` → updated to remove `work-overview.md` entry

## Pre-Migration Checks

Before starting, verify:

```bash
# 1. Manifest exists at v3.0 location
test -f docs/blueprint/.manifest.json

# 2. Read current version
jq -r '.format_version // "1.0.0"' docs/blueprint/.manifest.json

# 3. Verify version is 3.0.x
version=$(jq -r '.format_version // "1.0.0"' docs/blueprint/.manifest.json)
if [[ ! "$version" =~ ^3\.0 ]]; then
  echo "ERROR: Expected v3.0.x, found $version"
  exit 1
fi

# 4. Check for uncommitted changes (recommend commit first)
git status --porcelain
```

**Confirmation**: "Current version is v{version}. Proceed with migration to v3.1.0?"

## Migration Steps

### Step 1: Remove work-overview.md

The `work-overview.md` file has been consolidated into `feature-tracker.json` (tasks and current_phase fields).

```bash
# Check if work-overview.md exists
if [[ -f docs/blueprint/work-overview.md ]]; then
  echo "Found docs/blueprint/work-overview.md - will be removed"
fi
```

**Confirmation**: "Remove docs/blueprint/work-overview.md? (Task tracking is now in feature-tracker.json)"

```bash
rm -f docs/blueprint/work-overview.md
```

### Step 2: Ensure feature-tracker.json has required fields

If `feature-tracker.json` exists but is missing the `tasks` or `current_phase` fields added in v3.1, add them:

```bash
# Check if feature-tracker.json exists
if [[ -f docs/blueprint/feature-tracker.json ]]; then
  # Add tasks field if missing
  has_tasks=$(jq -e '.tasks' docs/blueprint/feature-tracker.json 2>/dev/null && echo "yes" || echo "no")
  has_phase=$(jq -e '.current_phase' docs/blueprint/feature-tracker.json 2>/dev/null && echo "yes" || echo "no")

  if [[ "$has_tasks" == "no" || "$has_phase" == "no" ]]; then
    echo "Adding missing fields to feature-tracker.json"
  fi
fi
```

```bash
# Add missing fields using jq
jq '
  if .tasks == null then .tasks = [] else . end |
  if .current_phase == null then .current_phase = null else . end
' docs/blueprint/feature-tracker.json > docs/blueprint/feature-tracker.json.tmp && \
mv docs/blueprint/feature-tracker.json.tmp docs/blueprint/feature-tracker.json
```

### Step 3: Clean Up Deprecated Generated Commands

Remove generated commands/skills from the now-deprecated `/blueprint:generate-commands`:

```bash
# Check for generated project skills
for path in \
  .claude/skills/project-continue/ \
  .claude/skills/project-test-loop/ \
  .claude/commands/project-continue.md \
  .claude/commands/project/continue.md \
  .claude/commands/project-test-loop.md \
  .claude/commands/project/test-loop.md; do
  if [[ -e "$path" ]]; then
    echo "Found deprecated: $path"
  fi
done

# Check manifest for generated entries
jq -r '.generated.commands // {} | keys[]' docs/blueprint/.manifest.json 2>/dev/null
```

**If deprecated entries found**, ask user:
```
Use AskUserQuestion:
question: "Found deprecated generated commands/skills. These are no longer needed. Remove them?"
options:
  - "Yes, remove deprecated commands (Recommended)"
  - "Keep for now"
```

**If "Yes"**:
```bash
# Remove deprecated generated skills
rm -rf .claude/skills/project-continue/ 2>/dev/null
rm -rf .claude/skills/project-test-loop/ 2>/dev/null

# Remove deprecated generated commands
rm -f .claude/commands/project-continue.md 2>/dev/null
rm -f .claude/commands/project/continue.md 2>/dev/null
rm -f .claude/commands/project-test-loop.md 2>/dev/null
rm -f .claude/commands/project/test-loop.md 2>/dev/null

# Clean up empty directories
rmdir .claude/commands/project 2>/dev/null
rmdir .claude/commands 2>/dev/null

# Remove entries from manifest
jq 'del(.generated.commands)' docs/blueprint/.manifest.json > docs/blueprint/.manifest.json.tmp && \
mv docs/blueprint/.manifest.json.tmp docs/blueprint/.manifest.json
```

### Step 4: Update Blueprint README

Remove `work-overview.md` entry from `docs/blueprint/README.md` if present:

```bash
if [[ -f docs/blueprint/README.md ]]; then
  # Check if README references work-overview.md
  if grep -q 'work-overview' docs/blueprint/README.md; then
    echo "Updating README to remove work-overview.md reference"
  fi
fi
```

Update the README contents table to replace the work-overview entry with feature-tracker.json (if not already present).

### Step 5: Update Manifest

Update the manifest to v3.1.0:

```bash
jq '
  .format_version = "3.1.0" |
  .updated_at = (now | strftime("%Y-%m-%dT%H:%M:%SZ")) |
  .upgrade_history += [{
    "from": "3.0.0",
    "to": "3.1.0",
    "date": (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
    "changes": [
      "Removed work-overview.md (consolidated into feature-tracker.json)",
      "Added tasks and current_phase fields to feature-tracker.json",
      "Cleaned up deprecated generated commands",
      "Updated blueprint README"
    ]
  }]
' docs/blueprint/.manifest.json > docs/blueprint/.manifest.json.tmp && \
mv docs/blueprint/.manifest.json.tmp docs/blueprint/.manifest.json
```

## Post-Migration Verification

After migration, verify:

```bash
# 1. Manifest exists with correct version
jq -r '.format_version' docs/blueprint/.manifest.json
# Expected: 3.1.0

# 2. work-overview.md removed
! test -f docs/blueprint/work-overview.md && echo "work-overview.md removed: OK"

# 3. feature-tracker.json has required fields (if it exists)
if [[ -f docs/blueprint/feature-tracker.json ]]; then
  jq -e '.tasks' docs/blueprint/feature-tracker.json > /dev/null && echo "tasks field: OK"
  jq -e 'has("current_phase")' docs/blueprint/feature-tracker.json > /dev/null && echo "current_phase field: OK"
fi

# 4. No deprecated generated commands
! test -d .claude/skills/project-continue && echo "project-continue skill removed: OK"
! test -d .claude/skills/project-test-loop && echo "project-test-loop skill removed: OK"
! test -f .claude/commands/project-continue.md && echo "project-continue command removed: OK"
! test -f .claude/commands/project-test-loop.md && echo "project-test-loop command removed: OK"

# 5. Upgrade history recorded
jq '.upgrade_history[-1]' docs/blueprint/.manifest.json
```

## Migration Summary Template

```
Blueprint Migration Complete (v3.0 → v3.1)

Progress tracking consolidated:
- Removed docs/blueprint/work-overview.md
- feature-tracker.json now handles tasks and current_phase

Deprecated commands cleaned up:
- {n} generated skills removed
- {n} generated commands removed

Manifest updated:
- format_version: 3.1.0
- upgrade_history entry added

Next steps:
1. Run /blueprint:status to verify configuration
2. Commit migration changes
```

## Rollback

If migration fails or needs to be reverted:

1. **Check git status** for changes made
2. **Restore from git** if changes were staged:
   ```bash
   git checkout -- docs/blueprint/
   git checkout -- .claude/
   ```

3. **Manual rollback**:
   ```bash
   # Restore manifest version
   jq '.format_version = "3.0.0"' docs/blueprint/.manifest.json > docs/blueprint/.manifest.json.tmp && \
   mv docs/blueprint/.manifest.json.tmp docs/blueprint/.manifest.json

   # work-overview.md would need to be recreated manually if needed
   # Generated commands would need to be regenerated via /blueprint:generate-commands
   ```

4. **Report failure point** for debugging
