# Migration: v1.x → v2.0

This document describes the migration from blueprint format version 1.x to 2.0.

## Overview

Version 2.0 introduces a three-layer architecture:
1. **Plugin layer** - Generic commands/skills from blueprint-plugin
2. **Generated layer** - Skills/commands regeneratable from PRDs
3. **Custom layer** - User-maintained overrides

Key changes:
- PRDs, ADRs, PRPs move from `.claude/blueprints/` to `docs/`
- Generated content moves to `.claude/blueprints/generated/`
- Manifest tracks generation metadata with content hashes
- Work-orders remain in `.claude/blueprints/work-orders/`

## Pre-Migration Checks

Before starting, verify:

```bash
# 1. Manifest exists
test -f .claude/blueprints/.manifest.json

# 2. Read current version
jq -r '.format_version // "1.0.0"' .claude/blueprints/.manifest.json

# 3. Check for uncommitted changes (recommend commit first)
git status --porcelain
```

## Migration Steps

### Step 1: Create docs/ Structure

Create project documentation directories:

```bash
mkdir -p docs/prds docs/adrs docs/prps
```

**Confirmation**: "Create docs/prds/, docs/adrs/, docs/prps/ directories?"

### Step 2: Move PRDs to docs/

Move existing PRD files:

```bash
# Check for existing PRDs
if [ -d .claude/blueprints/prds ] && [ "$(ls -A .claude/blueprints/prds)" ]; then
  mv .claude/blueprints/prds/* docs/prds/
  rmdir .claude/blueprints/prds
fi
```

**Confirmation**: "Move {count} PRD files from .claude/blueprints/prds/ to docs/prds/?"

### Step 3: Move ADRs to docs/

Move existing ADR files:

```bash
# Check for existing ADRs
if [ -d .claude/blueprints/adrs ] && [ "$(ls -A .claude/blueprints/adrs)" ]; then
  mv .claude/blueprints/adrs/* docs/adrs/
  rmdir .claude/blueprints/adrs
fi
```

**Confirmation**: "Move {count} ADR files from .claude/blueprints/adrs/ to docs/adrs/?"

### Step 4: Move PRPs to docs/

Move existing PRP files (if any):

```bash
# Check for existing PRPs
if [ -d .claude/blueprints/prps ] && [ "$(ls -A .claude/blueprints/prps)" ]; then
  mv .claude/blueprints/prps/* docs/prps/
  rmdir .claude/blueprints/prps
fi
```

**Confirmation**: "Move {count} PRP files from .claude/blueprints/prps/ to docs/prps/?"

### Step 5: Create generated/ Directory

Create the generated content directory structure:

```bash
mkdir -p .claude/blueprints/generated/skills
mkdir -p .claude/blueprints/generated/commands
```

### Step 6: Relocate Generated Skills

For each skill listed in `manifest.generated_artifacts.skills`:

1. Check if skill exists in `.claude/skills/`
2. Hash current content
3. Compare with original generation (if hash available)
4. If modified:
   - Ask user: "Keep in generated/ (will be regenerated)" or "Promote to custom/ (preserve modifications)"
5. Move to `.claude/blueprints/generated/skills/` or `.claude/skills/`

```bash
# Hash a skill file
sha256sum .claude/skills/architecture-patterns/skill.md | cut -d' ' -f1
```

**Confirmation for each modified skill**: "{skill-name} has been modified. Promote to custom layer to preserve changes?"

### Step 7: Relocate Generated Commands

Same process as Step 6, but for `.claude/commands/`:

1. Check manifest for generated commands
2. Hash current content
3. Compare and offer promote option for modified files
4. Move to `.claude/blueprints/generated/commands/` or keep in `.claude/commands/`

### Step 8: Update Manifest Schema

Transform manifest from v1.x to v2.0 schema:

**Old schema (v1.x):**
```json
{
  "format_version": "1.1.0",
  "generated_artifacts": {
    "commands": ["project-continue"],
    "skills": ["architecture-patterns"]
  }
}
```

**New schema (v2.0):**
```json
{
  "format_version": "2.0.0",
  "generated": {
    "skills": {
      "architecture-patterns": {
        "source": "docs/prds/project-overview.md",
        "source_hash": "sha256:...",
        "generated_at": "2025-12-22T...",
        "plugin_version": "2.0.0",
        "content_hash": "sha256:...",
        "status": "current"
      }
    },
    "commands": { ... }
  },
  "custom_overrides": {
    "skills": [],
    "commands": []
  }
}
```

### Step 9: Update Documentation References

If project has a `CLAUDE.md`, update any references to old paths:

| Old Path | New Path |
|----------|----------|
| `.claude/blueprints/prds/` | `docs/prds/` |
| `.claude/blueprints/adrs/` | `docs/adrs/` |
| `.claude/blueprints/prps/` | `docs/prps/` |

### Step 10: Clean Up Empty Directories

Remove empty old directories:

```bash
# Only remove if empty
[ -z "$(ls -A .claude/blueprints/prds 2>/dev/null)" ] && rmdir .claude/blueprints/prds 2>/dev/null
[ -z "$(ls -A .claude/blueprints/adrs 2>/dev/null)" ] && rmdir .claude/blueprints/adrs 2>/dev/null
[ -z "$(ls -A .claude/blueprints/prps 2>/dev/null)" ] && rmdir .claude/blueprints/prps 2>/dev/null
```

## Post-Migration Verification

After migration, verify:

```bash
# 1. Manifest version is 2.0.0
jq -r '.format_version' .claude/blueprints/.manifest.json

# 2. docs/ structure exists
ls -la docs/

# 3. generated/ structure exists
ls -la .claude/blueprints/generated/

# 4. Old directories removed
! test -d .claude/blueprints/prds
```

## Migration Summary Template

```
Blueprint Migration Complete (v1.x → v2.0)

Moved:
- {n} PRDs to docs/prds/
- {n} ADRs to docs/adrs/
- {n} PRPs to docs/prps/

Generated content:
- {n} skills in .claude/blueprints/generated/skills/
- {n} commands in .claude/blueprints/generated/commands/

Custom overrides (preserved modifications):
- {n} skills in .claude/skills/
- {n} commands in .claude/commands/

Manifest updated to format_version 2.0.0

Next steps:
1. Review docs/ structure matches project documentation standards
2. Run /blueprint:status to verify configuration
3. Commit migration changes
```

## Rollback

If migration fails or needs to be reverted:

1. Check git status for changes
2. Use `git checkout -- .claude/` to restore original .claude/ structure
3. Manually move docs/ content back if needed
4. Restore original manifest from git

```bash
# Full rollback
git checkout -- .claude/
rm -rf docs/prds docs/adrs docs/prps  # Only if created during migration
```
