# blueprint-derive-plans REFERENCE

Reference material for git analysis patterns, document templates, and detailed implementation guidance.

## Git Analysis Patterns

### Git Quality Scoring

Determine quality score based on conventional commit percentage:

| Conventional % | Score | Quality |
|---|---|---|
| 80%+ | 9-10 | Excellent |
| 50-79% | 6-8 | Good |
| 20-49% | 4-5 | Fair |
| <20% | 1-3 | Poor (graceful degradation) |

### Commit Scope Extraction

```bash
# Extract feature boundaries from conventional commit scopes
git log --oneline --format="%s" {scope} | grep -oE "^\w+\(([^)]+)\)" | \
  sed 's/.*(\([^)]*\)).*/\1/' | sort | uniq -c | sort -rn | head -20
```

For each scope with 3+ commits, record:
- Feature name (scope value)
- Commit count
- Date range (first to last commit)
- Commit types distribution (feat/fix/refactor)

### Architecture Decision Detection

```bash
# Technology migrations
git log --oneline --format="%s" {scope} | \
  grep -iE "(migrate|switch|replace|upgrade|adopt|move from|move to)" | head -20

# Major dependency changes
git log --oneline --format="%s" {scope} | \
  grep -iE "(add|install|introduce|integrate|remove|drop) .*(library|framework|package|dependency|database|orm)" | head -20

# Breaking changes
git log --oneline --format="%s" {scope} | grep -E "^[a-z]+(\([^)]+\))?!:" | head -20
git log --format="%B" {scope} | grep -iB5 "BREAKING CHANGE:" | head -30
```

For each identified decision, record:
- What changed (from commit message)
- When (commit date)
- Commit SHA (for reference)
- Confidence: High if explicit, Medium if inferred

### Issue References

```bash
# Find issue references
git log --oneline --format="%s %b" {scope} | \
  grep -oE "(Fixes|Closes|Resolves|Refs|Related to) #[0-9]+" | \
  sort | uniq -c | sort -rn | head -30
```

Map issues to features where possible.

### Release Boundary Detection

```bash
# Find release tags and commits between them
git tag -l | grep -E "^v?[0-9]+\.[0-9]+" | head -20

# Get commits between two releases
git log --oneline {tag1}..{tag2} | head -10
```

## Document Templates

### PRD Template

```markdown
# {Project Name} - Product Requirements Document

**Created**: {date}
**Status**: Retroactive (Generated from history)
**Version**: {latest_tag or "1.0"}
**Import Confidence**: {overall_score}/10

## Executive Summary

### Problem Statement
{Extracted from README or user input}
<!-- confidence: {score}/10 - {source} -->

### Proposed Solution
{Project description from README/analysis}
<!-- confidence: {score}/10 - {source} -->

### Business Impact
{Inferred or from user input}
<!-- confidence: {score}/10 - {source} -->

## Stakeholders & Personas

{From user input or marked as "Needs clarification"}

### User Personas

#### Primary: {Persona from user input}
- **Description**: {description}
- **Needs**: {needs}
- **Goals**: {goals}

## Functional Requirements

### Core Features

| ID | Feature | Description | Priority | Source |
|----|---------|-------------|----------|--------|
| FR-001 | {feature} | {from commits/code} | {P0/P1/P2} | git: {scope}, {commit_count} commits |
| FR-002 | {feature} | {description} | {priority} | git: {scope} |

### Feature Details

#### FR-001: {Feature Name}
- **Commits**: {first_sha}..{last_sha} ({date_range})
- **Related issues**: {issue_refs}
- **Key files**: {main_files}

## Non-Functional Requirements

### Performance
{Inferred from dependencies or marked as "Needs input"}

### Security
{Inferred from auth-related code or marked as "Needs input"}

### Compatibility
{From package.json engines, tsconfig target, etc.}

## Technical Considerations

### Architecture
{From Explore agent analysis}

### Tech Stack
{From dependency analysis}
- Language: {language}
- Framework: {framework}
- Testing: {test_framework}
- Database: {database if detected}

### Dependencies
{Key dependencies from manifest}

## Success Metrics

| Metric | Baseline | Target | Measurement |
|--------|----------|--------|-------------|
| {metric} | {current} | {target} | {how} |

<!-- Most metrics need user input for established projects -->

## Scope

### In Scope
{Inferred from implemented features}

### Out of Scope
{Marked as "Needs user input"}

## Timeline & Phases

### Current Phase: {Inferred from git activity}

### History
| Phase | Focus | Dates | Status |
|-------|-------|-------|--------|
| Initial Development | Core features | {first_commit} - {tag_v1} | Complete |
| {Phase 2} | {inferred} | {dates} | {status} |

---

## Import Metadata

**Generated by**: /blueprint:derive-plans
**Analysis date**: {date}
**Commits analyzed**: {count}
**Date range**: {first_commit_date} to {last_commit_date}
**Git quality score**: {score}/10

### Confidence Summary
| Section | Confidence | Notes |
|---------|------------|-------|
| Executive Summary | {score}/10 | {notes} |
| Features | {score}/10 | {notes} |
| Technical | {score}/10 | {notes} |
| Non-Functional | {score}/10 | {notes} |

### Sections Needing Review
- {list sections with low confidence}
```

### ADR Template

```markdown
# ADR-{number}: {Decision Title}

**Date**: {commit_date}
**Status**: Accepted (Retroactive)
**Confidence**: {score}/10

## Context

{Inferred from pre-change state or user input}
<!-- This decision was identified from git history. Original context may need clarification. -->

## Decision Drivers

- {driver from user input or inferred}
- {driver 2}

## Considered Options

1. **{Current choice}** - The implemented solution
2. **{Alternative 1}** - Common alternative for this type of decision
3. **{Alternative 2}** - Another common alternative

## Decision Outcome

**Chosen option**: "{Current choice}" because {user-provided rationale or "rationale needs documentation"}.

### Positive Consequences

- {inferred benefit from implementation}
- {benefit 2}

### Negative Consequences

- {known tradeoff if any}
- {limitation if any}

## Evidence

- **Commit**: {sha} - "{commit_message}"
- **Date**: {date}
- **Files changed**: {key files}

---

*Retroactively generated from git history via /blueprint:derive-plans*
*Original commit: {sha} on {date}*
```

### ADR Index Template

```markdown
# Architecture Decision Records

This directory contains Architecture Decision Records (ADRs) documenting significant technical decisions.

**Note**: These ADRs were retroactively generated from git history. Review and enhance rationale sections as needed.

## Index

| ADR | Title | Status | Date | Confidence |
|-----|-------|--------|------|------------|
| [0001](0001-{title}.md) | {title} | Accepted | {date} | {score}/10 |
| [0002](0002-{title}.md) | {title} | Accepted | {date} | {score}/10 |

## Template

New ADRs should follow the [MADR template](https://adr.github.io/madr/).
```

### PRP Template

```markdown
# PRP: {Feature/Task Name}

**Created**: {date}
**Status**: Suggested
**Source**: {TODO|Issue|Analysis}
**Confidence**: {score}/10

## Goal

{Extracted from TODO comment, issue title, or analysis}

### Why

{Inferred from context or marked as "Needs clarification"}

## Context

### Source Reference

**Origin**: {source_type}
- Location: `{file}:{line}` or Issue #{number}
- Text: "{original_text}"

### Codebase Intelligence

{From Explore agent - related code, patterns to follow}

### Known Gotchas

| Gotcha | Impact | Mitigation |
|--------|--------|------------|
| {identified concern} | {impact} | {suggested approach} |

## Suggested Implementation

{Basic outline based on similar features in codebase}

## TDD Requirements

{Template based on project testing patterns}

### Test Strategy
- Unit tests: {what to test}
- Integration tests: {if applicable}

---

*Suggested future work identified via /blueprint:derive-plans*
*Requires prioritization and detailed planning before execution*
```

## Manifest Update Format

```json
{
  "format_version": "3.0.0",
  "updated_at": "{ISO timestamp}",
  "structure": {
    "has_prds": true,
    "has_adrs": true,
    "has_prps": true
  },
  "import_metadata": {
    "imported_at": "{ISO timestamp}",
    "commits_analyzed": {count},
    "date_range": ["{start}", "{end}"],
    "git_quality_score": {score},
    "features_extracted": {count},
    "decisions_identified": {count},
    "future_work_suggested": {count},
    "overall_confidence": {score}
  },
  "generated_artifacts": [
    {
      "type": "prd",
      "file": "docs/prds/project-overview.md",
      "confidence": {score},
      "source": "import"
    },
    {
      "type": "adr",
      "file": "docs/adrs/0001-{title}.md",
      "confidence": {score},
      "source": "import"
    }
  ]
}
```

## Summary Report Format

```
Blueprint Import Complete!

**Analysis Summary**
- Commits analyzed: {N} ({date_range})
- Conventional commits: {percentage}%
- Git quality score: {score}/10

**Documents Generated**

PRD: docs/prds/project-overview.md (confidence: {score}/10)
   - Features documented: {N}
   - User clarifications incorporated: {N}

ADRs: {N} decisions documented
   - 0001-{title}.md (confidence: {score}/10)
   - 0002-{title}.md (confidence: {score}/10)
   ...

PRPs: {N} future work items suggested
   - docs/prps/{name}.md (from TODOs)
   - docs/prps/{name}.md (from issues)
   ...

**Needs Review**
{List sections/documents with confidence < 7}

**Next Steps**
1. Review documents marked "needs clarification"
2. Run `/blueprint:generate-rules` to create implementation patterns
3. Run `/blueprint:generate-commands` for workflow automation
```

## Error Handling

| Condition | Action |
|-----------|--------|
| Not a git repository | Error with message, suggest running from project root |
| No commits | Error: "Repository has no commit history" |
| No README and no docs | Warn, ask user for project description |
| Blueprint already has PRDs | Ask: Merge, Replace, or Cancel |
| gh CLI not available | Skip issue-based analysis, warn user |
| Very large repo (>5000 commits) | Suggest --quick or --since flag |
| No conventional commits | Graceful degradation: lower confidence, use file-based analysis |

## Implementation Tips

- **Git history quality matters**: Projects with conventional commits produce better results
- **User input improves accuracy**: Answer clarifying questions to increase confidence scores
- **Review low-confidence sections**: Focus review effort on sections marked < 7/10
- **Iterative refinement**: Run import once, then refine documents manually
- **Combine with existing docs**: If some documentation exists, import will incorporate it
