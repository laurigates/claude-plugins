name: Claude Code Changelog Review

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_full_review:
        description: 'Force full changelog review'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.compare.outputs.has_updates }}
      latest_version: ${{ steps.compare.outputs.latest_version }}
      changes_summary: ${{ steps.analyze.outputs.summary }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_RELEASE_PLEASE_TOKEN }}

      - name: Fetch Claude Code changelog
        id: fetch
        run: |
          curl -s https://raw.githubusercontent.com/anthropics/claude-code/refs/heads/main/CHANGELOG.md > /tmp/changelog.md
          echo "Fetched changelog"

      - name: Fetch Claude Code documentation
        id: fetch_docs
        run: |
          mkdir -p /tmp/claude-docs

          # Fetch the full documentation index
          curl -sf -o /tmp/claude-docs/llms.txt \
            https://code.claude.com/docs/llms.txt || echo "llms.txt fetch failed"

          # Fetch key documentation pages for review context
          declare -A DOC_URLS
          DOC_URLS[settings]="https://code.claude.com/docs/en/settings"
          DOC_URLS[features-overview]="https://code.claude.com/docs/en/features-overview"
          DOC_URLS[best-practices]="https://code.claude.com/docs/en/best-practices"
          DOC_URLS[claude-code-on-the-web]="https://code.claude.com/docs/en/claude-code-on-the-web"
          DOC_URLS[github-actions]="https://code.claude.com/docs/en/github-actions"

          FETCH_RESULTS=""
          for doc_name in "${!DOC_URLS[@]}"; do
            doc_url="${DOC_URLS[$doc_name]}"
            HTTP_CODE=$(curl -sf -o "/tmp/claude-docs/${doc_name}.html" -w '%{http_code}' "$doc_url" || true)
            DOC_SIZE=$(wc -c < "/tmp/claude-docs/${doc_name}.html" 2>/dev/null || echo "0")
            FETCH_RESULTS="${FETCH_RESULTS}${doc_name}: HTTP ${HTTP_CODE} (${DOC_SIZE} bytes)\n"
          done

          echo "docs_fetched=true" >> $GITHUB_OUTPUT
          printf "Documentation fetch results:\n%b" "$FETCH_RESULTS"

      - name: Extract latest version
        id: extract
        run: |
          # Extract first version number from changelog
          # Handles both "## 2.1.50" and "## [2.1.50]" formats
          LATEST=$(grep -oP '## \[?\K[0-9]+\.[0-9]+\.[0-9]+' /tmp/changelog.md | head -1)
          if [ -z "$LATEST" ]; then
            echo "::error::Failed to extract version from changelog"
            exit 1
          fi
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest Claude Code version: $LATEST"

      - name: Read last checked version
        id: read_tracked
        run: |
          if [ -f .claude-code-version-check.json ]; then
            TRACKED=$(jq -r '.lastCheckedVersion' .claude-code-version-check.json)
          else
            TRACKED="0.0.0"
          fi
          echo "tracked_version=$TRACKED" >> $GITHUB_OUTPUT
          echo "Last checked version: $TRACKED"

      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.extract.outputs.latest_version }}"
          TRACKED="${{ steps.read_tracked.outputs.tracked_version }}"
          FORCE="${{ inputs.force_full_review }}"

          if [ "$FORCE" = "true" ]; then
            echo "Forced full review requested"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Compare semantic versions
          version_gt() {
            test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
          }

          if version_gt "$LATEST" "$TRACKED"; then
            echo "New version detected: $TRACKED -> $LATEST"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "No new versions since $TRACKED"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT

      - name: Analyze changelog for plugin impacts
        id: analyze
        if: steps.compare.outputs.has_updates == 'true'
        run: |
          TRACKED="${{ steps.read_tracked.outputs.tracked_version }}"
          LATEST="${{ steps.extract.outputs.latest_version }}"

          echo "Analyzing changes from $TRACKED to $LATEST..."

          # Count relevant changes by searching for keywords
          HOOK_CHANGES=$(grep -ci 'hook' /tmp/changelog.md || echo "0")
          SKILL_CHANGES=$(grep -ci 'skill' /tmp/changelog.md || echo "0")
          AGENT_CHANGES=$(grep -ci 'agent' /tmp/changelog.md || echo "0")
          PERMISSION_CHANGES=$(grep -ci 'permission' /tmp/changelog.md || echo "0")
          BREAKING_CHANGES=$(grep -ci 'breaking' /tmp/changelog.md || echo "0")
          PLUGIN_CHANGES=$(grep -ci 'plugin' /tmp/changelog.md || echo "0")
          MCP_CHANGES=$(grep -ci 'mcp' /tmp/changelog.md || echo "0")

          SUMMARY="Hook: $HOOK_CHANGES, Skill: $SKILL_CHANGES, Agent: $AGENT_CHANGES, Permission: $PERMISSION_CHANGES, Plugin: $PLUGIN_CHANGES, MCP: $MCP_CHANGES, Breaking: $BREAKING_CHANGES"
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "Changes extracted for analysis"

      - name: Upload fetched documentation
        if: steps.compare.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-code-docs
          path: /tmp/claude-docs/
          retention-days: 30

  create-issue:
    needs: check-changelog
    if: needs.check-changelog.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read tracked version
        id: tracked
        run: |
          if [ -f .claude-code-version-check.json ]; then
            TRACKED=$(jq -r '.lastCheckedVersion' .claude-code-version-check.json)
            LAST_DATE=$(jq -r '.lastCheckedDate' .claude-code-version-check.json)
          else
            TRACKED="0.0.0"
            LAST_DATE="never"
          fi
          echo "version=$TRACKED" >> $GITHUB_OUTPUT
          echo "date=$LAST_DATE" >> $GITHUB_OUTPUT

      - name: Check for existing open issue
        id: check_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "changelog-review" --state open --json number --jq 'length')
          if [ "$EXISTING" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found existing open changelog review issue"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue body
        if: steps.check_issue.outputs.exists == 'false'
        env:
          LATEST_VERSION: ${{ needs.check-changelog.outputs.latest_version }}
          TRACKED_VERSION: ${{ steps.tracked.outputs.version }}
          LAST_DATE: ${{ steps.tracked.outputs.date }}
          CHANGES_SUMMARY: ${{ needs.check-changelog.outputs.changes_summary }}
        run: |
          python3 -c "
          import os

          latest = os.environ['LATEST_VERSION']
          tracked = os.environ['TRACKED_VERSION']
          last_date = os.environ['LAST_DATE']
          summary = os.environ.get('CHANGES_SUMMARY', 'N/A')

          body = '''## Claude Code Changelog Review Required

          **New Claude Code version detected!**

          - **Previous version:** {tracked}
          - **Latest version:** {latest}
          - **Last review date:** {last_date}

          ### Changelog Keyword Mentions

          {summary}

          ### Action Required

          Run the changelog review command to analyze changes:

          \`\`\`bash
          /changelog:review
          \`\`\`

          Or for a full review:

          \`\`\`bash
          /changelog:review --since {tracked}
          \`\`\`

          ### Changelog Link

          [View Claude Code Changelog](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)

          ### Areas to Check

          Review the changelog for changes in these areas that may impact plugins:

          - [ ] **Hooks** - New events, schema changes, behavior updates
          - [ ] **Skills/Commands** - Frontmatter changes, discovery updates
          - [ ] **Agents** - New capabilities, configuration options
          - [ ] **Permissions** - New patterns, security fixes
          - [ ] **MCP** - Server configuration, OAuth updates
          - [ ] **SDK** - API changes, new features
          - [ ] **Plugins** - Marketplace, plugin.json schema changes
          - [ ] **Breaking Changes** - Anything requiring immediate updates

          ### Documentation Review

          Verify plugin rules and skills are up-to-spec with current Claude Code documentation.
          Fetched docs are available as workflow artifacts for offline reference.

          - [ ] [Settings](https://code.claude.com/docs/en/settings) - Permission syntax, plugin config, hooks config, MCP config, sandbox settings
          - [ ] [Features Overview](https://code.claude.com/docs/en/features-overview) - Skills, hooks, agents, MCP, plugins architecture, context costs
          - [ ] [Best Practices](https://code.claude.com/docs/en/best-practices) - CLAUDE.md guidelines, skill patterns, subagent usage, headless mode
          - [ ] [Claude Code on the Web](https://code.claude.com/docs/en/claude-code-on-the-web) - SessionStart hooks, environment config, network access, dependency management
          - [ ] [GitHub Actions](https://code.claude.com/docs/en/github-actions) - claude-code-action v1 config, workflow patterns, skill usage in CI
          - [ ] [Full Documentation Index](https://code.claude.com/docs/llms.txt) - Complete docs reference

          #### Rules to Verify Against Docs

          Cross-check these project rules with the live documentation above:

          - `.claude/rules/plugin-structure.md` vs Settings (plugin.json schema), Features Overview (plugin architecture)
          - `.claude/rules/skill-development.md` vs Features Overview (skill system), Best Practices (skill patterns)
          - `.claude/rules/agentic-permissions.md` vs Settings (permission syntax), Features Overview (hooks, permissions)
          - `.claude/rules/release-please.md` vs Settings (version management)
          - `.claude/rules/skill-quality.md` vs Best Practices (CLAUDE.md size, skill design)
          - `.claude/rules/skill-naming.md` vs Features Overview (skill namespacing, plugin skills)

          ### Potentially Affected Plugins

          Based on common change areas:
          - `hooks-plugin` - Hook system changes
          - `agent-patterns-plugin` - Agent and MCP changes
          - `configure-plugin` - Permission and configuration changes
          - All plugins - Skill/command changes

          ### After Review

          1. Update `.claude-code-version-check.json` with the new version
          2. Create follow-up issues for any required changes
          3. Update any rules files that are out of spec with live docs
          4. Close this issue

          ---
          *This issue was automatically created by the changelog review workflow.*
          '''.format(tracked=tracked, latest=latest, last_date=last_date, summary=summary)

          import textwrap
          body = textwrap.dedent(body).strip()

          with open('/tmp/issue-body.md', 'w') as f:
              f.write(body)
          "

      - name: Create changelog review issue
        if: steps.check_issue.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LATEST_VERSION: ${{ needs.check-changelog.outputs.latest_version }}
          TRACKED_VERSION: ${{ steps.tracked.outputs.version }}
        run: |
          gh issue create \
            --title "Review Claude Code changelog: $TRACKED_VERSION â†’ $LATEST_VERSION" \
            --label "changelog-review,maintenance" \
            --body-file /tmp/issue-body.md

  update-tracking:
    needs: [check-changelog, create-issue]
    if: needs.check-changelog.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_RELEASE_PLEASE_TOKEN }}

      - name: Update version tracking
        env:
          LATEST_VERSION: ${{ needs.check-changelog.outputs.latest_version }}
        run: |
          DATE=$(date +%Y-%m-%d)

          # Read existing file or create new
          if [ -f .claude-code-version-check.json ]; then
            # Update existing file
            jq --arg version "$LATEST_VERSION" --arg date "$DATE" '
              .lastCheckedVersion = $version |
              .lastCheckedDate = $date |
              .reviewedChanges = [
                {
                  "version": $version,
                  "date": $date,
                  "relevantChanges": [],
                  "actionsRequired": ["Review pending - see GitHub issue"]
                }
              ] + .reviewedChanges
            ' .claude-code-version-check.json > /tmp/updated.json
            mv /tmp/updated.json .claude-code-version-check.json
          else
            # Create new file
            python3 -c "
          import json, os
          data = {
              'lastCheckedVersion': os.environ['LATEST_VERSION'],
              'lastCheckedDate': '$DATE',
              'changelogUrl': 'https://raw.githubusercontent.com/anthropics/claude-code/refs/heads/main/CHANGELOG.md',
              'reviewedChanges': [{
                  'version': os.environ['LATEST_VERSION'],
                  'date': '$DATE',
                  'relevantChanges': [],
                  'actionsRequired': ['Review pending - see GitHub issue']
              }]
          }
          with open('.claude-code-version-check.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('Created new tracking file')
          "
          fi

          echo "Updated tracking to version $LATEST_VERSION"

      - name: Create PR for tracking update
        env:
          GH_TOKEN: ${{ secrets.MY_RELEASE_PLEASE_TOKEN }}
          LATEST_VERSION: ${{ needs.check-changelog.outputs.latest_version }}
        run: |
          if git diff --quiet .claude-code-version-check.json; then
            echo "No changes to commit"
            exit 0
          fi

          BRANCH="chore/update-version-tracking-${LATEST_VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add .claude-code-version-check.json
          git commit -m "chore: update Claude Code version tracking to ${LATEST_VERSION}"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "chore: update Claude Code version tracking to ${LATEST_VERSION}" \
            --body "Automated update of \`.claude-code-version-check.json\` to track Claude Code version ${LATEST_VERSION}." \
            --label "maintenance"
